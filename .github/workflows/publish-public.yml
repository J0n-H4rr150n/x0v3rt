name: Promote to Public

run-name: "Promote to Public${{ inputs.description && format(' - {0}', inputs.description) || '' }}"

on:
  workflow_dispatch:
    inputs:
      description:
        description: "Optional: Brief description of this promotion (e.g., 'Security fixes', 'New features')"
        required: false
        type: string

jobs:
  push-to-public:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      public_sha: ${{ steps.publish.outputs.public_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Tag private release
        shell: bash
        run: |
          set -e
          git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          PRIVATE_TAG="private-$(date +%Y%m%d-%H%M%S)"
          git tag "$PRIVATE_TAG"
          git push origin "$PRIVATE_TAG"

      - name: Push code to public repo
        id: publish
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          set -e
          if [[ -z "$PUBLIC_REPO_TOKEN" ]]; then
            echo "PUBLIC_REPO_TOKEN is not set. Add it as a secret in this repo." >&2
            exit 1
          fi
          PUBLIC_REMOTE="https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/J0n-H4rr150n/x0v3rt.git"

          # Snapshot private repo contents
          TMP_DIR="$(mktemp -d)"
          git archive --format=tar HEAD | tar -x -C "$TMP_DIR"

          # Create branch from public main so it shares history for PR
          git remote add public "$PUBLIC_REMOTE" || git remote set-url public "$PUBLIC_REMOTE"
          git fetch public main

          # Create branch name with timestamp
          BRANCH_NAME="promote-$(date +%Y%m%d-%H%M%S)"
          git checkout -B "$BRANCH_NAME" public/main

          # Replace working tree with private snapshot
          find . -mindepth 1 -maxdepth 1 ! -name .git -exec rm -rf {} +
          rsync -a --exclude .git "$TMP_DIR"/ ./

          # Remove entire .github directory - public repo has its own workflows
          # rm -rf .github

          git add -A
          COMMIT_MSG="Promote to public"
          if [[ -n "${{ inputs.description }}" ]]; then
            COMMIT_MSG="${COMMIT_MSG}: ${{ inputs.description }}"
          fi
          git commit -m "$COMMIT_MSG"
          PUBLIC_SHA=$(git rev-parse HEAD)

          git push public HEAD:"$BRANCH_NAME"

          echo "public_sha=$PUBLIC_SHA" >> "$GITHUB_OUTPUT"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "âœ… Code pushed to branch: $BRANCH_NAME"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          PR_TITLE="Promote to Public"
          if [[ -n "${{ inputs.description }}" ]]; then
            PR_TITLE="${PR_TITLE}: ${{ inputs.description }}"
          fi

          gh pr create \
            --repo J0n-H4rr150n/x0v3rt \
            --base main \
            --head "${{ steps.publish.outputs.branch_name }}" \
            --title "$PR_TITLE" \
            --body "## Automated Promotion from Private Repo

          **Branch:** \`${{ steps.publish.outputs.branch_name }}\`
          **Commit:** \`${{ steps.publish.outputs.public_sha }}\`

          Review the changes and merge when ready."

          echo "ðŸ“¦ Pull request created!"
          echo "ðŸ”— Review at: https://github.com/J0n-H4rr150n/x0v3rt/pulls"
